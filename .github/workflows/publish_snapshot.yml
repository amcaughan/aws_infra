name: Publish snapshot to public repo

on:
  # Manual trigger from the Actions tab
  workflow_dispatch:

  # Scheduled run: every saturday at 6 PM pacific
  # Which is every sunday at 2 AM UTC
  schedule:
    - cron: "0 2 * * 0"

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout private repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Git identity for snapshot commits
        run: |
          git config --global user.name "amcaughan"
          git config --global user.email "77643664+amcaughan@users.noreply.github.com"

      - name: Clone public repo
        env:
          PUBLIC_REPO_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
        run: |
          git clone "https://x-access-token:${PUBLIC_REPO_TOKEN}@github.com/amcaughan/aws-infra.git" public-repo

      - name: Sync files into public repo
        run: |
          rsync -av --delete \
            --exclude '.git' \
            --exclude '.github' \
            ./ public-repo/

      - name: Commit and push with randomized evening time
        env:
          PUBLIC_REPO_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
        run: |
          cd public-repo

          # Only commit if there are changes compared to last snapshot
          if [ -n "$(git status --porcelain)" ]; then
            # ---- CONFIG: evening window in your local time ----
            TZ_REGION="America/Los_Angeles"
            START_HOUR_LOCAL=18   # earliest hour (18:00 = 6pm)
            END_HOUR_LOCAL=22     # latest hour (22:59 = 10:59pm)

            # Random hour in [START_HOUR_LOCAL, END_HOUR_LOCAL]
            HOUR_RANGE=$((END_HOUR_LOCAL - START_HOUR_LOCAL + 1))
            RAND_OFFSET=$((RANDOM % HOUR_RANGE))
            COMMIT_HOUR_LOCAL=$((START_HOUR_LOCAL + RAND_OFFSET))

            # Random minute 0â€“59
            COMMIT_MINUTE_LOCAL=$((RANDOM % 60))

            # Today's date in local time
            COMMIT_DATE_LOCAL=$(TZ="$TZ_REGION" date +'%Y-%m-%d')

            # Local datetime in your evening window
            COMMIT_DATETIME_LOCAL="$COMMIT_DATE_LOCAL $(printf '%02d' "$COMMIT_HOUR_LOCAL"):$(printf '%02d' "$COMMIT_MINUTE_LOCAL"):00"

            # ISO 8601 with timezone offset, e.g. 2025-12-09T20:37:00-08:00
            COMMIT_DATETIME_ISO=$(TZ="$TZ_REGION" date -d "$COMMIT_DATETIME_LOCAL" --iso-8601=seconds)

            echo "Using commit datetime (local): $COMMIT_DATETIME_ISO"

            GIT_AUTHOR_DATE="$COMMIT_DATETIME_ISO" \
            GIT_COMMITTER_DATE="$COMMIT_DATETIME_ISO" \
            git add .
            git commit -m "Automated snapshot $COMMIT_DATETIME_ISO"
            git push origin main
          else
            echo "No changes to commit; skipping snapshot."
          fi
