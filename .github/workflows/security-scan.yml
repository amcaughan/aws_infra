name: security

on:
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      deep_gitleaks:
        description: "Scan full git history with gitleaks (slower)"
        type: boolean
        required: false
        default: false

permissions:
  contents: read

jobs:
  checkov:
    uses: amcaughan/shared_workflows/.github/workflows/scan-checkov.yml@090b092361b1e27a6d99ee1a37a8838c8479da54
    with:
      artifact_name: sarif-checkov
      sarif_filename: checkov.sarif
      scan_path: .

  trivy:
    uses: amcaughan/shared_workflows/.github/workflows/scan-trivy.yml@090b092361b1e27a6d99ee1a37a8838c8479da54
    with:
      artifact_name: sarif-trivy
      sarif_filename: trivy.sarif
      scan_path: .
      scanners: vuln,license

  gitleaks:
    uses: amcaughan/shared_workflows/.github/workflows/scan-gitleaks.yml@090b092361b1e27a6d99ee1a37a8838c8479da54
    with:
      artifact_name: sarif-gitleaks
      sarif_filename: gitleaks.sarif
      redact: true
      scan_history: ${{ github.event_name == 'pull_request' || inputs.deep_gitleaks }}

  actionlint:
    uses: amcaughan/shared_workflows/.github/workflows/scan-actionlint.yml@090b092361b1e27a6d99ee1a37a8838c8479da54
    with:
      artifact_name: sarif-actionlint
      sarif_filename: actionlint.sarif

  report:
    runs-on: ubuntu-latest
    if: ${{ always() }}
    needs: [checkov, trivy, gitleaks, actionlint]

    # required for PR commenting; harmless on workflow_dispatch
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/download-artifact@v4
        with:
          path: sarif

      - uses: amcaughan/shared_workflows/.github/actions/sarif-report@090b092361b1e27a6d99ee1a37a8838c8479da54
        with:
          title: "Repo security report"
          sarif_glob: "sarif/**/**/*.sarif"
          out_html: "out/security-report.html"

      - uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: out/security-report.html
          retention-days: 14

      - name: Attach HTML to Step Summary
        shell: bash
        run: |
          {
            echo "<details open><summary>Security report (HTML)</summary>"
            cat out/security-report.html
            echo "</details>"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Build PR comment body
        if: ${{ github.event_name == 'pull_request' }}
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p out
          {
            echo "## Repo security report"
            echo ""
            echo "<details open><summary>Report</summary>"
            echo ""
            cat out/security-report.html
            echo ""
            echo "</details>"
          } > out/pr-comment.md

      - name: Comment report on PR (upsert)
        if: ${{ github.event_name == 'pull_request' }}
        uses: amcaughan/shared_workflows/.github/actions/comment-pr@090b092361b1e27a6d99ee1a37a8838c8479da54
        with:
          comment_name: security-report
          body_file: out/pr-comment.md
          token: ${{ secrets.GITHUB_TOKEN }}
