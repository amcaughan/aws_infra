name: security

on:
  pull_request:
    branches: [main]
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  checkov:
    uses: amcaughan/shared_workflows/.github/workflows/scan-checkov.yml@9f7cc699a3d32b47340bca3489d1df99c5ac9669
    with:
      artifact_name: sarif-checkov
      sarif_filename: checkov.sarif
      scan_path: .

  trivy:
    uses: amcaughan/shared_workflows/.github/workflows/scan-trivy.yml@9f7cc699a3d32b47340bca3489d1df99c5ac9669
    with:
      artifact_name: sarif-trivy
      sarif_filename: trivy.sarif
      scan_path: .
      scanners: vuln,license

  gitleaks:
    uses: amcaughan/shared_workflows/.github/workflows/scan-gitleaks.yml@9f7cc699a3d32b47340bca3489d1df99c5ac9669
    with:
      artifact_name: sarif-gitleaks
      sarif_filename: gitleaks.sarif
      redact: true

  actionlint:
    uses: amcaughan/shared_workflows/.github/workflows/scan-actionlint.yml@9f7cc699a3d32b47340bca3489d1df99c5ac9669
    with:
      artifact_name: sarif-actionlint
      sarif_filename: actionlint.sarif

  report:
    runs-on: ubuntu-latest
    needs: [checkov, trivy, gitleaks, actionlint]
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: sarif

      - uses: amcaughan/shared_workflows/sarif-report@9f7cc699a3d32b47340bca3489d1df99c5ac9669
        with:
          title: "Repo security report"
          sarif_glob: "sarif/**/**/*.sarif"
          out_html: "out/security-report.html"

      - uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: out/security-report.html
          retention-days: 14
